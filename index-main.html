<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO-Optimized Title & Meta -->
    <title>The Village Vault - Clash of Clans Collection Tracker | Hero Skins, Sceneries, Decorations & Obstacles
    </title>
    <meta name="description"
        content="Free Clash of Clans collection tracker. Paste your game JSON to track hero skins, sceneries, decorations, obstacles and see your progress instantly.">
    <meta name="keywords"
        content="clash of clans tracker, coc collection tracker, hero skins tracker, sceneries tracker, decorations tracker, obstacles tracker, clash of clans json paste, village vault">
    <meta name="author" content="The Village Vault">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Social Sharing -->
    <meta property="og:title" content="The Village Vault - Clash of Clans Collection Tracker">
    <meta property="og:description"
        content="Track every hero skin, scenery, decoration & obstacle in Clash of Clans by pasting your JSON data. Free & instant!">
    <meta property="og:type" content="website">
    <meta property="og:image" content="src/assets/logo.png">
    <meta property="og:image:alt" content="The Village Vault Logo">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="The Village Vault - Clash of Clans Collection Tracker">
    <meta name="twitter:description"
        content="Paste your CoC JSON to track hero skins, sceneries, decorations & obstacles.">
    <meta name="twitter:image" content="src/assets/logo.png">

    <!-- Favicon & Styles -->
    <link rel="icon" href="src/assets/favicon.ico">
    <link rel="stylesheet" href="styles.css">

    <!-- Structured Data for Google -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "The Village Vault",
        "description": "Free web tool to track Clash of Clans hero skins, sceneries, decorations, and obstacles by pasting JSON data.",
        "url": "https://yourdomain.com",
        "applicationCategory": "Game",
        "operatingSystem": "Web",
        "offers": { "@type": "Offer", "price": "0" },
        "featureList": ["Hero Skins Tracker", "Sceneries Tracker", "Decorations & Obstacles", "JSON Import", "Progress Stats"]
    }
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5062214479421683"
        crossorigin="anonymous"></script>
</head>

<body>
    <div id="root">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-inner">
                    <img src="src/assets/logo.png" alt="The Village Vault - Clash of Clans Collection Tracker"
                        class="header-logo" onerror="this.style.display='none'">
                    <div class="header-text">
                        <h1 class="header-title">THE VILLAGE VAULT</h1>
                        <p class="header-subtitle">Track Every Treasure. Claim Every Item.</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Category Tabs -->
        <nav class="category-nav">
            <div class="category-tabs-container">
                <button class="category-tab active" data-category="cosmetic-compendium" aria-current="true">
                    <svg class="category-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z" />
                    </svg>
                    <span class="category-label">COSMETIC COMPENDIUM</span>
                    <span class="category-label-short">COMPENDIUM</span>
                </button>
                <button class="category-tab" data-category="hero-wardrobe" aria-current="false">
                    <svg class="category-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                    <span class="category-label">HERO'S WARDROBE</span>
                    <span class="category-label-short">WARDROBE</span>
                </button>
                <button class="category-tab" data-category="home-village-decor" aria-current="false">
                    <svg class="category-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                    </svg>
                    <span class="category-label">HOME VILLAGE DECOR</span>
                    <span class="category-label-short">DECOR</span>
                </button>
                <button class="category-tab" data-category="sceneries" aria-current="false">
                    <svg class="category-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                    <span class="category-label">SCENERIES</span>
                    <span class="category-label-short">SCENERIES</span>
                </button>
            </div>
        </nav>

        <div class="main-container">
            <!-- Sidebar Filter (Desktop) -->
            <aside class="sidebar">
                <div class="sidebar-content">
                    <h2 class="sidebar-title">Filter Your Treasury</h2>

                    <!-- Search -->
                    <div class="search-container">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="search-input" class="search-input" placeholder="Search for items...">
                    </div>

                    <!-- Item Type Filter -->
                    <div class="filter-group" id="type-filter-group">
                        <h3 class="filter-title">Item Type</h3>
                        <div class="filter-options filter-buttons" id="type-filter-options">
                            <button class="filter-btn active" data-type-filter="all">All Items</button>
                            <button class="filter-btn" data-type-filter="heroskin">Hero Skins</button>
                            <button class="filter-btn" data-type-filter="scenery">Sceneries</button>
                            <button class="filter-btn" data-type-filter="obstacle">Obstacles</button>
                            <button class="filter-btn" data-type-filter="decoration">Decorations</button>
                            <button class="filter-btn" data-type-filter="clan">Clan House Parts</button>
                        </div>
                    </div>

                    <!-- Hero Filter (Hero's Wardrobe only) -->
                    <div class="filter-group" id="hero-filter-group" style="display: none;">
                        <h3 class="filter-title">Hero</h3>
                        <div class="filter-options">
                            <label class="filter-checkbox">
                                <input type="checkbox" value="barbarian_king" class="hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Barbarian King</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="archer_queen" class="hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Archer Queen</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="royal_champion" class="hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Royal Champion</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="grand_warden" class="hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Grand Warden</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="minion_prince" class="hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Minion Prince</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="battle_machine" class="hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Battle Machine</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="flying_machine" class="hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Flying Machine</span>
                            </label>
                        </div>
                    </div>

                    <!-- Ownership Filter -->
                    <div class="filter-group">
                        <h3 class="filter-title">Ownership</h3>
                        <div class="filter-options">
                            <label class="filter-checkbox">
                                <input type="checkbox" value="owned" class="ownership-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Owned</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="missing" class="ownership-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Missing</span>
                            </label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <div class="content-container">
                    <!-- Data Upload & Progress -->
                    <div class="upload-section">
                        <div class="upload-controls">
                            <button id="upload-btn" class="btn btn-primary">
                                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <span>Upload Collection Data</span>
                            </button>
                            <button id="clear-data-btn" class="btn btn-icon-small" style="display: none;">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                                </svg>
                            </button>

                        </div>
                        <div id="welcome-banner" class="welcome-banner">
                            <h3>Welcome to The Village Vault!</h3>
                            <p>Upload your collection data to start tracking your treasures and unlock special features.
                            </p>
                        </div>
                        <div id="global-progress" class="progress-tracker global"
                            style="display:none; margin-bottom: 1rem;">
                            <strong>Overall Collection: <span id="global-owned">0</span>/<span
                                    id="global-total">0</span> (<span id="global-pct">0</span>%)</strong>
                            <div class="progress-bar"
                                style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                                <div class="progress-fill"
                                    style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--gold), var(--gold-light)); transition: width 0.3s ease;">
                                </div>
                            </div>
                        </div>
                        <div id="progress-tracker" class="progress-tracker" style="display: none;"></div>
                    </div>

                    <!-- Mobile Filter Button -->
                    <div class="mobile-filter-section">
                        <button id="mobile-filter-btn" class="btn btn-mobile-filter">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            <span>Filter / Sort</span>
                        </button>
                    </div>

                    <!-- Desktop Sort -->
                    <div class="desktop-controls">
                        <div class="items-count">
                            Showing <span id="items-count">0</span> items
                        </div>
                        <div class="sort-container">
                            <label for="sort-select" class="sort-label">Sort By:</label>
                            <select id="sort-select" class="sort-select">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="name-asc">Name A-Z</option>
                                <option value="name-desc">Name Z-A</option>
                            </select>
                        </div>
                    </div>

                    <!-- Items Grid -->
                    <div class="items-grid" id="items-grid"></div>

                    <!-- No Items Message -->
                    <div id="no-items-message" class="no-items-message" style="display: none;">
                        <p class="no-items-title">No items found</p>
                        <p class="no-items-subtitle">Try adjusting your filters</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal for Data Upload -->
        <div id="upload-modal" class="modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Upload Your Collection Data
                    </h2>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <p class="modal-description">Paste your game's JSON data below to track your collection progress.</p>

                <div class="modal-instructions">
                    <h4>How to get your data:</h4>
                    <ol>
                        <li>Open your game's data export feature</li>
                        <li>Copy the entire JSON data output</li>
                        <li>Paste it into the text area below</li>
                        <li>Click "Analyze Collection"</li>
                    </ol>
                </div>

                <div class="modal-form">
                    <label class="textarea-label">JSON Data</label>
                    <textarea id="json-input" class="json-textarea"
                        placeholder='Paste your JSON data here...'></textarea>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary modal-cancel-btn">Cancel</button>
                    <button id="analyze-btn" class="btn btn-primary">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" />
                        </svg>
                        <span>Analyze Collection</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Filter Modal -->
        <div id="filter-modal" class="modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Filter & Sort</h2>
                    <button class="modal-close-btn">&times;</button>
                </div>

                <div class="modal-form">
                    <!-- Mobile Search -->
                    <div class="search-container">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="mobile-search-input" class="search-input"
                            placeholder="Search for items...">
                    </div>

                    <!-- Mobile Type Filter -->
                    <div class="filter-group" id="mobile-type-filter-group">
                        <h3 class="filter-title">Item Type</h3>
                        <div class="filter-options filter-buttons" id="mobile-type-filter-options">
                            <button class="filter-btn active" data-type-filter="all">All Items</button>
                            <button class="filter-btn" data-type-filter="heroskin">Hero Skins</button>
                            <button class="filter-btn" data-type-filter="scenery">Sceneries</button>
                            <button class="filter-btn" data-type-filter="obstacle">Obstacles</button>
                            <button class="filter-btn" data-type-filter="decoration">Decorations</button>
                            <button class="filter-btn" data-type-filter="clan">Clan House Parts</button>
                        </div>
                    </div>

                    <!-- Mobile Hero Filter -->
                    <div class="filter-group" id="mobile-hero-filter-group" style="display: none;">
                        <h3 class="filter-title">Hero</h3>
                        <div class="filter-options">
                            <label class="filter-checkbox">
                                <input type="checkbox" value="barbarian_king" class="mobile-hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Barbarian King</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="archer_queen" class="mobile-hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Archer Queen</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="royal_champion" class="mobile-hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Royal Champion</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="grand_warden" class="mobile-hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Grand Warden</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="minion_prince" class="mobile-hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Minion Prince</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="battle_machine" class="mobile-hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Battle Machine</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="flying_machine" class="mobile-hero-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Flying Machine</span>
                            </label>
                        </div>
                    </div>

                    <!-- Mobile Ownership Filter -->
                    <div class="filter-group">
                        <h3 class="filter-title">Ownership</h3>
                        <div class="filter-options">
                            <label class="filter-checkbox">
                                <input type="checkbox" value="owned" class="mobile-ownership-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Owned</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" value="missing" class="mobile-ownership-filter">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Missing</span>
                            </label>
                        </div>
                    </div>

                    <!-- Mobile Sort -->
                    <div class="filter-group">
                        <h3 class="filter-title">Sort By</h3>
                        <select id="mobile-sort-select" class="sort-select">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="name-asc">Name A-Z</option>
                            <option value="name-desc">Name Z-A</option>
                        </select>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary modal-cancel-btn" style="flex: 1;">Cancel</button>
                    <button id="apply-filters-btn" class="btn btn-primary" style="flex: 1;">Apply</button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container"></div>
    </div>

    <div id="loading-screen" class="loading-screen">
        <div class="spinner"></div>
        <p>Loading The Village Vault...</p>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            allItems: {},
            items: [],
            userOwnedCodes: new Set(),
            hasUserData: false,
            activeCategory: 'cosmetic-compendium',
            searchQuery: '',
            selectedHeroes: [],
            selectedOwnership: [],
            selectedTypes: [],
            sortBy: 'newest',
        };

        let itemDetailsDatabase = {};

        // ============================================
        // LOAD JSON FILES
        // ============================================
        async function loadJSON(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("HTTP Error " + res.status);
                return await res.json();
            } catch (err) {
                console.error("Error loading", url, err);
                return null;
            }
        }

        async function loadAllMasterData() {
            const decorations = await loadJSON("src/data-json/decorations.json");
            const obstacles = await loadJSON("src/data-json/obstacles.json");
            const heroesData = await loadJSON("src/data-json/heros.json");
            const sceneries = await loadJSON("src/data-json/sceneries.json");
            const itemDetails = await loadJSON("src/data-json/item-details.json");

            itemDetailsDatabase = itemDetails || {};
            const itemDetailsSafe = itemDetails || {};

            function findItemDetails(itemName, itemType) {
                if (!itemDetailsSafe || !itemName) {
                    return null;
                }

                const normalizedName = itemName.toLowerCase().trim();

                if (itemType === 'decoration' && itemDetailsSafe.decorations) {
                    const categories = ['permanent_shop', 'war_league', 'limited_events', 'lunar_new_year'];
                    for (const cat of categories) {
                        if (itemDetailsSafe.decorations[cat]) {
                            const found = itemDetailsSafe.decorations[cat].find(d =>
                                d.name.toLowerCase().trim() === normalizedName
                            );
                            if (found) {
                                return found;
                            }
                        }
                    }
                } else if (itemType === 'obstacle' && itemDetailsSafe.obstacles) {
                    const categories = ['clashmas_trees', 'halloween', 'anniversary_cakes', 'special_events', 'meteorites_2025'];
                    for (const cat of categories) {
                        if (itemDetailsSafe.obstacles[cat]) {
                            const found = itemDetailsSafe.obstacles[cat].find(o =>
                                o.name.toLowerCase().trim() === normalizedName
                            );
                            if (found) {
                                return found;
                            }
                        }
                    }
                } else if (itemType === 'heroskin' && itemDetailsSafe.hero_skins) {
                    const heroes = ['barbarian_king', 'archer_queen', 'grand_warden', 'royal_champion', 'minion_prince'];
                    for (const hero of heroes) {
                        if (itemDetailsSafe.hero_skins[hero]) {
                            const found = itemDetailsSafe.hero_skins[hero].find(s =>
                                s.name.toLowerCase().trim() === normalizedName
                            );
                            if (found) {
                                return found;
                            }
                        }
                    }
                } else if (itemType === 'scenery' && itemDetailsSafe.sceneries) {
                    let sceneryArray = [];
                    if (Array.isArray(itemDetailsSafe.sceneries)) {
                        sceneryArray = itemDetailsSafe.sceneries;
                    } else if (itemDetailsSafe.sceneries.all_sceneries && Array.isArray(itemDetailsSafe.sceneries.all_sceneries)) {
                        sceneryArray = itemDetailsSafe.sceneries.all_sceneries;
                    }

                    const found = sceneryArray.find(s =>
                        s.name && s.name.toLowerCase().trim() === normalizedName
                    );
                    if (found) {
                        return found;
                    }
                }

                return null;
            }

            const formattedDecorations = decorations ? decorations.map(item => {
                const details = findItemDetails(item.name, 'decoration');
                return {
                    code: String(item.Code),
                    name: item.name || "Unknown Decoration",
                    image: item.image || "",
                    rarity: item.rarity || "common",
                    category: "Decoration",
                    type: "decoration",
                    owned: false,
                    description: details?.description || "A decorative item for your village.",
                    released: details?.released || "Unknown",
                    availability: details?.availability || "Available in shop"
                };
            }) : [];

            const formattedObstacles = obstacles ? obstacles.map(item => {
                const details = findItemDetails(item.name, 'obstacle');
                return {
                    code: String(item.Code),
                    name: item.name || "Unknown Obstacle",
                    image: item.image || "",
                    rarity: item.rarity || "common",
                    category: "Obstacle",
                    type: "obstacle",
                    owned: false,
                    description: details?.description || "An obstacle that can be removed or kept.",
                    released: details?.released || "Unknown",
                    availability: details?.availability || "Spawns naturally"
                };
            }) : [];

            const formattedHeroSkins = [];
            if (heroesData && heroesData.heroes) {
                heroesData.heroes.forEach(hero => {
                    if (hero.skins && Array.isArray(hero.skins)) {
                        const heroId = hero.name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

                        hero.skins.forEach(skin => {
                            const details = findItemDetails(skin.skin_name, 'heroskin');
                            formattedHeroSkins.push({
                                code: String(skin.code),
                                name: skin.skin_name || "Unknown Skin",
                                image: skin.image_path || "",
                                rarity: details?.rarity || skin.rarity || "common",
                                category: "Hero Skin",
                                heroName: hero.name,
                                heroId: heroId,
                                type: "heroskin",
                                owned: false,
                                description: details?.description || `A special skin for ${hero.name}.`,
                                released: details?.released || "Unknown",
                                availability: details?.availability || "Available in shop"
                            });
                        });
                    }
                });
            }

            const rawSceneries = sceneries && (
                Array.isArray(sceneries) ? sceneries :
                    sceneries.sceneries || sceneries.all_sceneries || []
            );

            const formattedSceneries = rawSceneries.map(item => {
                const details = findItemDetails(item.name || item.Name, 'scenery');
                return {
                    code: String(item.Code || item.code),
                    name: item.name || item.Name || "Unknown Scenery",
                    image: item.image || item.image_path || "",
                    rarity: item.rarity || "common",
                    category: "Scenery",
                    type: "scenery",
                    owned: false,
                    description: details?.description || "A beautiful scenery for your village.",
                    released: details?.released || "Unknown",
                    availability: details?.availability || "Available in shop"
                };
            });

            const formattedClanCapital = [];

            state.allItems = {
                'cosmetic-compendium': [
                    ...formattedDecorations,
                    ...formattedObstacles,
                    ...formattedHeroSkins,
                    ...formattedSceneries,
                    ...formattedClanCapital
                ],
                'hero-wardrobe': formattedHeroSkins,
                'home-village-decor': [...formattedDecorations, ...formattedObstacles],
                'sceneries': formattedSceneries
            };

            state.items = state.allItems['cosmetic-compendium'];
            console.log("Loaded items:", {
                'Cosmetic Compendium': state.allItems['cosmetic-compendium'].length,
                'Hero Wardrobe': state.allItems['hero-wardrobe'].length,
                'Home Village Decor': state.allItems['home-village-decor'].length,
                'Sceneries': state.allItems['sceneries'].length
            });

            document.getElementById("loading-screen")?.classList.add("fade-out");
            setTimeout(() => document.getElementById("loading-screen")?.remove(), 600);
        }

        // ============================================
        // JSON PARSER
        // ============================================
        function extractCodesFromJSON(obj) {
            const codes = new Set();

            function walk(v) {
                if (Array.isArray(v)) {
                    v.forEach(item => {
                        if (typeof item === "number") {
                            codes.add(String(item));
                        } else if (item && typeof item === "object") {
                            walk(item);
                        }
                    });
                } else if (v && typeof v === "object") {
                    if ("data" in v && typeof v.data === "number") {
                        codes.add(String(v.data));
                    }
                    if ("code" in v) {
                        codes.add(String(v.code));
                    }
                    Object.values(v).forEach(walk);
                }
            }

            walk(obj);
            return [...codes];
        }

        function parseUserData(jsonString) {
            try {
                const parsed = JSON.parse(jsonString);
                const codes = extractCodesFromJSON(parsed);

                state.userOwnedCodes = new Set(codes);
                sessionStorage.setItem('userCollectionData', jsonString);

                Object.keys(state.allItems).forEach(categoryId => {
                    state.allItems[categoryId] = state.allItems[categoryId].map(item => ({
                        ...item,
                        owned: state.userOwnedCodes.has(item.code)
                    }));
                });

                state.items = state.items.map(item => ({
                    ...item,
                    owned: state.userOwnedCodes.has(item.code)
                }));

                state.hasUserData = true;
                return { success: true, message: `Matched ${codes.length} unique codes.` };
            } catch (err) {
                console.error("Parse error:", err);
                return { success: false, message: "Invalid JSON" };
            }
        }

        // ============================================
        // FILTERING & SORTING
        // ============================================
        function filterByType(type) {
            state.selectedTypes = type === 'all' ? [] : [type];
            updateUI();
        }

        function filterByHero(heroId) {
            if (state.selectedHeroes.includes(heroId)) {
                state.selectedHeroes = state.selectedHeroes.filter(h => h !== heroId);
            } else {
                state.selectedHeroes = [...state.selectedHeroes, heroId];
            }
            updateUI();
        }

        function switchCategory(categoryId) {
            state.activeCategory = categoryId;
            state.items = state.allItems[categoryId] || [];

            if (state.hasUserData) {
                state.items = state.items.map(item => ({
                    ...item,
                    owned: state.userOwnedCodes.has(item.code)
                }));
            }

            if (categoryId !== 'hero-wardrobe') {
                state.selectedHeroes = [];
            }

            state.selectedHeroes = [];
            state.selectedTypes = [];
            updateTypeFilterUI(categoryId);
            state.searchQuery = '';
            updateUI();
        }

        function updateTypeFilterUI(categoryId) {
            const typeFilterOptions = document.getElementById('type-filter-options');
            const mobileTypeFilterOptions = document.getElementById('mobile-type-filter-options');

            const filterConfigs = {
                'cosmetic-compendium': [
                    { value: 'all', label: 'All Items' },
                    { value: 'heroskin', label: 'Hero Skins' },
                    { value: 'scenery', label: 'Sceneries' },
                    { value: 'obstacle', label: 'Obstacles' },
                    { value: 'decoration', label: 'Decorations' },
                    { value: 'clan', label: 'Clan House Parts' }
                ],
                'hero-wardrobe': [
                    { value: 'heroskin', label: 'Hero Skins', disabled: true }
                ],
                'sceneries': [
                    { value: 'scenery', label: 'Sceneries', disabled: true }
                ],
                'home-village-decor': [
                    { value: 'all', label: 'All Items' },
                    { value: 'decoration', label: 'Decorations' },
                    { value: 'obstacle', label: 'Obstacles' }
                ]
            };

            const filters = filterConfigs[categoryId] || [];
            const filterHTML = filters.map((f, i) =>
                `<button class="filter-btn ${i === 0 ? 'active' : ''}" data-type-filter="${f.value}" ${f.disabled ? 'disabled style="opacity: 0.7; cursor: not-allowed;"' : ''}>${f.label}</button>`
            ).join('');

            if (typeFilterOptions) typeFilterOptions.innerHTML = filterHTML;
            if (mobileTypeFilterOptions) mobileTypeFilterOptions.innerHTML = filterHTML;

            attachTypeFilterListeners();
        }

        function filterByOwnership(ownership) {
            if (state.selectedOwnership.includes(ownership)) {
                state.selectedOwnership = [];
            } else {
                state.selectedOwnership = [ownership];
            }
            updateUI();
        }

        function getFilteredItems() {
            let filtered = state.items.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    (item.code && item.code.toString().includes(state.searchQuery));

                const matchType = state.selectedTypes.length === 0 || state.selectedTypes.includes(item.type);

                const matchHero = state.activeCategory !== 'hero-wardrobe' ||
                    state.selectedHeroes.length === 0 ||
                    (item.heroId && state.selectedHeroes.includes(item.heroId));

                const matchOwnership =
                    state.selectedOwnership.length === 0 ||
                    (state.selectedOwnership.includes("owned") && item.owned) ||
                    (state.selectedOwnership.includes("missing") && !item.owned);

                return matchSearch && matchType && matchHero && matchOwnership;
            });

            switch (state.sortBy) {
                case "oldest": filtered.sort((a, b) => a.code - b.code); break;
                case "name-asc": filtered.sort((a, b) => a.name.localeCompare(b.name)); break;
                case "name-desc": filtered.sort((a, b) => b.name.localeCompare(b.name)); break;
                case "newest":
                default: filtered.sort((a, b) => b.code - a.code);
            }
            return filtered;
        }

        // ============================================
        // RENDERING UI
        // ============================================
        function createItemCard(item) {
            const container = document.createElement("div");
            container.className = "item-card-container";

            const card = document.createElement("div");
            card.className = `item-card rarity-${item.rarity} type-${item.type}`;
            if (state.hasUserData && !item.owned) card.classList.add("grayscale");

            let typeBadgeText = '';
            if (item.type === 'decoration') typeBadgeText = 'Decoration';
            else if (item.type === 'obstacle') typeBadgeText = 'Obstacle';
            else if (item.type === 'heroskin') typeBadgeText = 'Hero Skin';
            else if (item.type === 'scenery') typeBadgeText = 'Scenery';
            else if (item.type === 'clan') typeBadgeText = 'Clan Item';
            else typeBadgeText = item.category;

            const ownershipBadge = state.hasUserData ? `
        <div class="item-status-badge ${item.owned ? 'owned' : 'missing'}">
            ${item.owned ? 'Owned' : 'Missing'}
        </div>
    ` : '';

            const frontHTML = `
        <div class="item-card-front">
            <div class="item-type-badge ${item.type}">
                ${typeBadgeText}
            </div>
            <div class="item-image-container">
                ${ownershipBadge}
                <img src="${item.image}" class="item-image" loading="lazy" alt="${item.name}">
            </div>
            <div class="item-info">
                <h3>${item.name}</h3>
                <p>${item.category}</p>
            </div>
        </div>
    `;

            card.innerHTML = frontHTML;

            card.addEventListener('click', () => {
                showItemDetailModal(item);
            });
            container.appendChild(card);
            return container;
        }

        function renderItems() {
            const list = document.getElementById("items-grid");
            const msg = document.getElementById("no-items-message");
            const count = document.getElementById("items-count");

            const items = getFilteredItems();

            list.innerHTML = "";
            count.textContent = items.length;

            if (!items.length) {
                msg.style.display = "block";
                return;
            }
            msg.style.display = "none";

            items.forEach(i => list.appendChild(createItemCard(i)));
        }

        function updateProgressTracker() {
            const el = document.getElementById("progress-tracker");
            if (!state.hasUserData) {
                el.style.display = "none";
                return;
            }

            let categoryItems = state.allItems[state.activeCategory] || [];

            if (state.selectedTypes.length > 0) {
                categoryItems = categoryItems.filter(item => state.selectedTypes.includes(item.type));
            }

            if (state.activeCategory === 'hero-wardrobe' && state.selectedHeroes.length > 0) {
                categoryItems = categoryItems.filter(item => item.heroId && state.selectedHeroes.includes(item.heroId));
            }

            const owned = categoryItems.filter(i => i.owned).length;
            const total = categoryItems.length;
            const pct = total > 0 ? Math.round((owned / total) * 100) : 0;

            el.style.display = "block";
            el.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span style="font-size: 0.9rem; font-weight: 600;">${owned}/${total} items collected</span>
            <span style="font-size: 1.1rem; font-weight: 700; color: var(--gold);">${pct}%</span>
        </div>
        <div class="progress-bar" style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
            <div class="progress-fill" style="width: ${pct}%; height: 100%; background: linear-gradient(90deg, var(--gold), var(--gold-light)); transition: width 0.3s ease;"></div>
        </div>
    `;
        }

        function updateGlobalProgress() {
            if (!state.hasUserData) {
                document.getElementById("global-progress").style.display = "none";
                return;
            }
            const all = Object.values(state.allItems).flat();
            const owned = all.filter(i => i.owned).length;
            const total = all.length;
            const pct = total > 0 ? Math.round((owned / total) * 100) : 0;

            document.getElementById("global-progress").style.display = "block";
            document.getElementById("global-owned").textContent = owned;
            document.getElementById("global-total").textContent = total;
            document.getElementById("global-pct").textContent = pct;
            document.querySelector("#global-progress .progress-fill").style.width = pct + "%";
        }

        function updateUI() {
            renderItems();
            updateProgressTracker();
            updateGlobalProgress();

            const heroFilterGroup = document.getElementById('hero-filter-group');
            const mobileHeroFilterGroup = document.getElementById('mobile-hero-filter-group');
            const isHeroWardrobe = state.activeCategory === 'hero-wardrobe';

            if (heroFilterGroup) {
                heroFilterGroup.style.display = isHeroWardrobe ? 'block' : 'none';
            }
            if (mobileHeroFilterGroup) {
                mobileHeroFilterGroup.style.display = isHeroWardrobe ? 'block' : 'none';
            }
        }

        // ============================================
        // EVENT HANDLING
        // ============================================
        function handleDataUpload() {
            const input = document.getElementById("json-input").value.trim();
            if (!input) {
                showToast("Error", "Please paste your JSON!", "error");
                return;
            }

            const result = parseUserData(input);
            if (result.success) {
                showToast("Success!", result.message, "success");
                closeModal("upload-modal");
                document.getElementById("clear-data-btn").style.display = "block";
                document.getElementById("welcome-banner").style.display = "none";
                updateUI();
            } else {
                showToast("Invalid JSON", result.message, "error");
            }
        }

        function handleDataClear() {
            state.userOwnedCodes = new Set();
            Object.keys(state.allItems).forEach(categoryId => {
                state.allItems[categoryId] = state.allItems[categoryId].map(i => ({ ...i, owned: false }));
            });
            state.items = state.items.map(i => ({ ...i, owned: false }));
            state.hasUserData = false;
            sessionStorage.removeItem('userCollectionData');
            document.getElementById("clear-data-btn").style.display = "none";
            document.getElementById("welcome-banner").style.display = "block";
            updateUI();
            showToast("Cleared", "Your data has been reset.", "success");
        }

        function handleExportCollection() {
            const ownedItems = state.allItems['cosmetic-compendium'].filter(item => item.owned);
            const exportData = {
                ownedCodes: Array.from(state.userOwnedCodes),
                ownedItems: ownedItems.map(item => ({
                    code: item.code,
                    name: item.name,
                    type: item.type
                }))
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'village_vault_collection.json';
            a.click();
            URL.revokeObjectURL(url);

            showToast("Exported", "Your collection has been downloaded.", "success");
        }

        function attachTypeFilterListeners() {
            const typeFilterButtons = document.querySelectorAll('[data-type-filter]:not([disabled])');
            typeFilterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.getAttribute('data-type-filter');
                    const parentGroup = btn.closest('.filter-options');
                    parentGroup.querySelectorAll('[data-type-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filterByType(type);
                });
            });
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showToast(title, message, type = "success") {
            const container = document.getElementById("toast-container");
            if (!container) return;

            const toast = document.createElement("div");
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
    `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add("toast-fade-out");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ============================================
        // INITIALIZE APP
        // ============================================
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("Loading JSON data...");
            await loadAllMasterData();

            const userCollectionData = sessionStorage.getItem('userCollectionData');

            if (userCollectionData) {
                try {
                    const result = parseUserData(userCollectionData);
                    if (result.success) {
                        document.getElementById("clear-data-btn").style.display = "block";
                        document.getElementById("welcome-banner").style.display = "none";
                    }
                    console.log("Loaded collection data from session:", result);
                } catch (err) {
                    console.error("Error loading session collection data:", err);
                }
            }

            updateUI();

            // Category Tab Switching
            const categoryTabs = document.querySelectorAll('.category-tab');
            categoryTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const categoryId = tab.getAttribute('data-category');

                    categoryTabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-current', 'false');
                    });
                    tab.classList.add('active');
                    tab.setAttribute('aria-current', 'true');

                    switchCategory(categoryId);
                });
            });

            // Search
            const searchInput = document.getElementById("search-input");
            const debouncedUpdateFromSearch = debounce(() => updateUI(), 300);
            if (searchInput) {
                searchInput.addEventListener("input", e => {
                    state.searchQuery = e.target.value;
                    debouncedUpdateFromSearch();
                });
            }

            // Sort
            const sortSelect = document.getElementById("sort-select");
            if (sortSelect) {
                sortSelect.addEventListener("change", e => {
                    state.sortBy = e.target.value;
                    updateUI();
                });
            }

            // Type filters
            attachTypeFilterListeners();

            // Ownership filters
            const ownershipCheckboxes = document.querySelectorAll('.ownership-filter');
            ownershipCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', e => {
                    const ownership = e.target.value;

                    ownershipCheckboxes.forEach(cb => {
                        if (cb !== e.target) {
                            cb.checked = false;
                        }
                    });

                    filterByOwnership(ownership);
                });
            });

            // Hero filters
            const heroFilterCheckboxes = document.querySelectorAll('.hero-filter');
            heroFilterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', e => {
                    const heroId = e.target.value;
                    filterByHero(heroId);
                    const mobileCheckbox = document.querySelector(`.mobile-hero-filter[value="${heroId}"]`);
                    if (mobileCheckbox) {
                        mobileCheckbox.checked = checkbox.checked;
                    }
                });
            });

            // Mobile Hero filters
            const mobileHeroFilterCheckboxes = document.querySelectorAll('.mobile-hero-filter');
            mobileHeroFilterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', e => {
                    const heroId = e.target.value;
                    filterByHero(heroId);
                    const desktopCheckbox = document.querySelector(`.hero-filter[value="${heroId}"]`);
                    if (desktopCheckbox) {
                        desktopCheckbox.checked = checkbox.checked;
                    }
                });
            });

            // Upload / Clear
            const uploadBtn = document.getElementById("upload-btn");
            if (uploadBtn) {
                uploadBtn.addEventListener("click", () => openModal("upload-modal"));
            }

            const analyzeBtn = document.getElementById("analyze-btn");
            if (analyzeBtn) {
                analyzeBtn.addEventListener("click", handleDataUpload);
            }

            const clearDataBtn = document.getElementById("clear-data-btn");
            if (clearDataBtn) {
                clearDataBtn.addEventListener("click", handleDataClear);
            }

            const exportBtn = document.getElementById("export-btn");
            if (exportBtn) {
                exportBtn.addEventListener("click", handleExportCollection);
            }

            // Modal close buttons
            document.querySelectorAll(".modal-close-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const modal = btn.closest(".modal");
                    if (modal) {
                        modal.style.display = "none";
                    }
                });
            });

            // Modal overlay close
            document.querySelectorAll(".modal-overlay").forEach(overlay => {
                overlay.addEventListener("click", () => {
                    const modal = overlay.closest(".modal");
                    if (modal) {
                        modal.style.display = "none";
                    }
                });
            });

            // Cancel buttons
            document.querySelectorAll(".modal-cancel-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const modal = btn.closest(".modal");
                    if (modal) {
                        modal.style.display = "none";
                    }
                });
            });

            // Mobile filter button
            const mobileFilterBtn = document.getElementById("mobile-filter-btn");
            if (mobileFilterBtn) {
                mobileFilterBtn.addEventListener("click", () => openModal("filter-modal"));
            }

            // Mobile ownership filters
            document.querySelectorAll(".mobile-ownership-filter").forEach(checkbox => {
                checkbox.addEventListener("change", () => {
                    const ownership = checkbox.value;

                    document.querySelectorAll(".mobile-ownership-filter").forEach(cb => {
                        if (cb !== checkbox) {
                            cb.checked = false;
                        }
                    });

                    filterByOwnership(ownership);
                });
            });

            // Apply filters button (mobile)
            const applyFiltersBtn = document.getElementById("apply-filters-btn");
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener("click", () => {
                    closeModal("filter-modal");
                });
            }

            // Sync mobile search
            const mobileSearchInput = document.getElementById("mobile-search-input");
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener("input", e => {
                    state.searchQuery = e.target.value;
                    const desktopSearch = document.getElementById("search-input");
                    if (desktopSearch) {
                        desktopSearch.value = e.target.value;
                    }
                    updateUI();
                });
            }

            // Sync mobile sort
            const mobileSortSelect = document.getElementById("mobile-sort-select");
            if (mobileSortSelect) {
                mobileSortSelect.addEventListener("change", e => {
                    state.sortBy = e.target.value;
                    const desktopSort = document.getElementById("sort-select");
                    if (desktopSort) {
                        desktopSort.value = e.target.value;
                    }
                    updateUI();
                });
            }

            // Item Detail Modal
            let currentModal = null;

            function showItemDetailModal(item) {
                let modal = document.getElementById('item-detail-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'item-detail-modal';
                    modal.className = 'item-detail-modal';
                    document.body.appendChild(modal);
                }

                const modalHTML = `
                <div class="item-detail-content">
                    <button class="item-detail-close" onclick="closeItemDetailModal()"></button>
                    <div class="item-detail-header">
                        <div class="item-detail-image">
                            <img src="${item.image}" alt="${item.name}" loading="lazy">
                        </div>
                        <div class="item-detail-title-section">
                            <h2 class="item-detail-title">${item.name}</h2>
                            <div class="item-detail-category">${item.category}</div>
                            ${state.hasUserData ? `
                                <div class="item-status-badge ${item.owned ? 'owned' : 'missing'}">
                                    ${item.owned ? 'Owned' : 'Missing'}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="item-detail-body">
                        <div class="item-detail-section">
                            <div class="item-detail-label">Description</div>
                            <div class="item-detail-value">${item.description || 'No description available.'}</div>
                        </div>
                        <div class="item-detail-section">
                            <div class="item-detail-label">Released</div>
                            <div class="item-detail-value">${item.released || 'Unknown'}</div>
                        </div>
                        <div class="item-detail-section">
                            <div class="item-detail-label">How to Obtain</div>
                            <div class="item-detail-value">${item.availability || 'Unknown'}</div>
                        </div>
                        ${item.heroName ? `
                            <div class="item-detail-section">
                                <div class="item-detail-label">Hero</div>
                                <div class="item-detail-value">${item.heroName}</div>
                            </div>
                        ` : ''}
                        <div class="item-detail-section">
                            <div class="item-detail-label">Rarity</div>
                            <div class="item-detail-value" style="text-transform: capitalize;">${item.rarity || 'Common'}</div>
                        </div>
                    </div>
                </div>
            `;

                modal.innerHTML = modalHTML;
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                window.currentModal = modal;

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeItemDetailModal();
                    }
                });
            }

            function closeItemDetailModal() {
                const modal = document.getElementById('item-detail-modal');
                if (!modal) return;

                const content = modal.querySelector('.item-detail-content');
                if (content) {
                    content.classList.add('closing');
                    setTimeout(() => {
                        modal.classList.remove('show');
                        document.body.style.overflow = '';
                        window.currentModal = null;
                    }, 300);
                }
            }

            window.showItemDetailModal = showItemDetailModal;
            window.closeItemDetailModal = closeItemDetailModal;

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    if (window.currentModal) {
                        window.closeItemDetailModal();
                    }
                }
            });
        });
    </script>

</body>

</html>